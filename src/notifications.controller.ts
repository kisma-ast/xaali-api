import { Controller, Post, Body, Logger, Get, Param } from '@nestjs/common';
import { EmailService } from './email.service';

@Controller('notifications')
export class NotificationsController {
  private readonly logger = new Logger(NotificationsController.name);

  constructor(
    private readonly emailService: EmailService
  ) {}

  @Post('send-tracking')
  async sendTrackingNotifications(@Body() data: {
    caseId: string;
    trackingCode: string;
    trackingLink: string;
    phone: string;
    email?: string;
    amount: number;
    citizenName?: string;
    problemCategory?: string;
    clientQuestion?: string;
    aiResponse?: string;
    caseTitle?: string;
    followUpQuestions?: string[];
    followUpAnswers?: string[];
  }) {
    try {
      console.log('üìß Envoi notifications de suivi:', data);

      // Log du suivi (remplace la sauvegarde en base)
      console.log('üìã Donn√©es de suivi:', {
        trackingCode: data.trackingCode,
        caseId: data.caseId,
        citizenName: data.citizenName,
        amount: data.amount
      });

      // Envoyer email si disponible
      if (data.email) {
        await this.emailService.sendTrackingNotification(
          data.email,
          data.trackingCode,
          data.trackingLink,
          data.amount
        );
        console.log('‚úÖ Email envoy√© √†', data.email);
      }

      // Envoyer WhatsApp
      await this.sendWhatsAppNotification(
        data.phone,
        data.trackingCode,
        data.trackingLink,
        data.amount
      );
      console.log('‚úÖ WhatsApp envoy√© √†', data.phone);

      return { success: true, message: 'Dossier complet cr√©√© et notifications envoy√©es' };
    } catch (error) {
      console.error('‚ùå Erreur envoi notifications:', error);
      return { success: false, message: 'Erreur envoi notifications' };
    }
  }

  @Get('tracking/:code')
  async getTrackingInfo(@Param('code') trackingCode: string) {
    return { success: false, message: 'Service de suivi temporairement indisponible' };
  }

  @Get('trackings/all')
  async getAllTrackings() {
    return { success: false, message: 'Service de suivi temporairement indisponible' };
  }

  @Post('send-tracking-email')
  async sendTrackingEmail(@Body() data: {
    caseId: string;
    trackingCode: string;
    trackingLink: string;
    phone: string;
    email: string;
    amount: number;
    citizenName: string;
    problemCategory: string;
    clientQuestion: string;
    aiResponse: string;
    caseTitle: string;
    followUpQuestions: string[];
    followUpAnswers: string[];
    caseData: any;
  }) {
    try {
      await this.emailService.sendTrackingEmail(
        data.trackingCode,
        data.trackingLink,
        data.email,
        data.caseData
      );
      
      console.log('‚úÖ Email avec lien de suivi envoy√© √†:', data.email);
      
      return {
        success: true,
        message: 'Email avec lien de suivi envoy√©'
      };
    } catch (error) {
      console.error('‚ùå Erreur envoi email suivi:', error);
      return {
        success: false,
        message: 'Erreur lors de l\'envoi de l\'email'
      };
    }
  }

  @Get('get-case/:trackingCode')
  async getCaseByTracking(@Param('trackingCode') trackingCode: string) {
    try {
      const caseData = this.emailService.getCaseData(trackingCode);
      
      if (caseData) {
        return {
          success: true,
          caseData
        };
      }
      
      return {
        success: false,
        message: 'Dossier non trouv√©'
      };
    } catch (error) {
      console.error('‚ùå Erreur r√©cup√©ration dossier:', error);
      return {
        success: false,
        message: 'Erreur lors de la r√©cup√©ration du dossier'
      };
    }
  }

  private async sendWhatsAppNotification(
    phone: string,
    trackingCode: string,
    trackingLink: string,
    amount: number
  ) {
    try {
      // Simuler l'envoi WhatsApp (√† remplacer par une vraie API WhatsApp)
      const message = `üéâ Paiement confirm√© !

Montant: ${amount} FCFA
Code de suivi: ${trackingCode}

Suivez votre dossier ici:
${trackingLink}

Un avocat va bient√¥t prendre en charge votre cas.

- √âquipe Xaali`;

      console.log('üì± WhatsApp √† envoyer √†', phone, ':', message);
      
      // TODO: Int√©grer une API WhatsApp Business (Twilio, etc.)
      
      return { success: true };
    } catch (error) {
      console.error('‚ùå Erreur WhatsApp:', error);
      throw error;
    }
  }
}